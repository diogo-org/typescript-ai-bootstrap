name: Publish Package

on:
  workflow_run:
    workflows: ["Build"]
    types:
      - completed
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read
      actions: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@diogo-raphael-cravo'
      
      - name: Wait for artifact availability
        id: wait-artifact
        run: |
          echo "Checking artifact availability for workflow run ${{ github.event.workflow_run.id }}..."
          MAX_ATTEMPTS=30
          ATTEMPT=0
          ARTIFACT_FOUND=false
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Checking for 'dist' artifact..."
            
            # Query GitHub API for artifacts
            RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts")
            
            # Check if artifact exists
            ARTIFACT_COUNT=$(echo "$RESPONSE" | jq '.artifacts | length')
            
            if [ "$ARTIFACT_COUNT" -gt 0 ]; then
              ARTIFACT_NAME=$(echo "$RESPONSE" | jq -r '.artifacts[0].name')
              if [ "$ARTIFACT_NAME" = "dist" ]; then
                echo "✓ Artifact 'dist' found and ready for download"
                ARTIFACT_FOUND=true
                break
              fi
            fi
            
            echo "Artifact not yet available, waiting 10 seconds..."
            sleep 10
          done
          
          if [ "$ARTIFACT_FOUND" = false ]; then
            echo "::error::Artifact 'dist' not found after $MAX_ATTEMPTS attempts"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download build artifacts
        id: download-artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true
      
      - name: Verify artifact download
        if: steps.download-artifact.outcome == 'failure'
        run: |
          echo "::error::Failed to download build artifacts from workflow run ${{ github.event.workflow_run.id }}"
          exit 1
      
      - name: Verify dist directory contents
        run: |
          echo "Verifying dist/ directory contents..."
          
          if [ ! -d "dist" ]; then
            echo "::error::dist/ directory does not exist after artifact download"
            exit 1
          fi
          
          FILE_COUNT=$(find dist -type f | wc -l)
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "::error::dist/ directory is empty - no files to publish"
            exit 1
          fi
          
          echo "✓ Found $FILE_COUNT file(s) in dist/ directory"
          echo "Contents:"
          ls -lah dist/
      
      - name: Publish to GitHub Packages
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
